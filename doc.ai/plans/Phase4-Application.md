# Phase 4: 应用层实现计划

本阶段实现 NanoBot.Net 的应用层，包括 CLI 命令、依赖注入配置、测试和部署。

## 阶段目标

实现完整的应用入口，支持命令行交互和 Gateway 服务模式，完成测试和部署准备。

## 相关方案文档

- [CLI.md](../solutions/CLI.md) - CLI 命令层设计
- [Testing.md](../solutions/Testing.md) - 测试方案设计

## 阶段依赖

- Phase 1 基础设施层已完成
- Phase 2 核心服务层已完成
- Phase 3 Agent 核心层已完成
- 所有核心模块可用

## 任务清单概览

| 任务清单 | 主要内容 | 并行度 |
|----------|----------|--------|
| [依赖注入配置模块](#任务清单-依赖注入配置模块) | DI 容器配置和扩展方法 | 高 |
| [CLI 命令模块](#任务清单-cli-命令模块) | 各 CLI 命令实现 | 高 |
| [集成测试模块](#任务清单-集成测试模块) | 端到端测试和集成测试 | 中 |
| [部署准备模块](#任务清单-部署准备模块) | Docker 和发布配置 | 高 |

---

## 任务清单：依赖注入配置模块

### 任务目标

实现完整的依赖注入配置，支持服务注册和生命周期管理。

### 相关方案文档

- 各模块设计文档中的依赖关系

### 任务依赖

- 所有核心模块已完成

### 任务列表

#### Task 4.1.1: 创建服务扩展方法基类

**描述**: 创建服务注册的扩展方法基础设施。

**交付物**:
- ServiceCollectionExtensions.cs 文件
- AddNanoBotCore 扩展方法

**完成标准**:
- 支持链式调用
- 支持配置选项

---

#### Task 4.1.2: 实现配置服务注册

**描述**: 实现配置相关服务的注册。

**交付物**:
- AddNanoBotConfiguration 扩展方法
- AgentConfig 注册
- 各配置类注册

**完成标准**:
- 配置正确加载
- 支持热重载

---

#### Task 4.1.3: 实现基础设施服务注册

**描述**: 实现基础设施层服务的注册。

**交付物**:
- AddNanoBotInfrastructure 扩展方法
- IWorkspaceManager 注册
- IBootstrapLoader 注册
- IMessageBus 注册

**完成标准**:
- 服务生命周期正确
- 依赖注入正确

---

#### Task 4.1.4: 实现提供商服务注册

**描述**: 实现提供商层服务的注册。

**交付物**:
- AddNanoBotProviders 扩展方法
- IProviderRegistry 注册
- 各提供商注册

**完成标准**:
- 提供商正确注册
- 默认提供商设置正确

---

#### Task 4.1.5: 实现工具服务注册

**描述**: 实现工具层服务的注册。

**交付物**:
- AddNanoBotTools 扩展方法
- IToolRegistry 注册
- 各内置工具注册

**完成标准**:
- 工具正确注册
- Schema 正确生成

---

#### Task 4.1.6: 实现通道服务注册

**描述**: 实现通道层服务的注册。

**交付物**:
- AddNanoBotChannels 扩展方法
- IChannelManager 注册
- 各通道适配器注册

**完成标准**:
- 通道正确注册
- 根据配置启用

---

#### Task 4.1.7: 实现后台服务注册

**描述**: 实现后台服务的注册。

**交付物**:
- AddNanoBotServices 扩展方法
- ICronService 注册
- IHeartbeatService 注册
- ISkillsLoader 注册
- ISubagentManager 注册

**完成标准**:
- 后台服务正确注册
- 支持托管服务

---

#### Task 4.1.8: 实现 Agent 服务注册

**描述**: 实现 Agent 核心层服务的注册。

**交付物**:
- AddNanoBotAgent 扩展方法
- IAgent 注册
- IAgentContext 注册
- IMemoryStore 注册
- ISessionManager 注册

**完成标准**:
- Agent 服务正确注册
- 依赖链完整

---

#### Task 4.1.9: 实现完整服务注册

**描述**: 实现聚合所有服务的扩展方法。

**交付物**:
- AddNanoBot 扩展方法
- 所有子模块注册调用

**完成标准**:
- 一键注册所有服务
- 支持选择性注册

---

#### Task 4.1.10: 编写 DI 配置单元测试

**描述**: 编写依赖注入配置的单元测试。

**交付物**:
- ServiceCollectionTests.cs 文件
- 服务解析测试

**完成标准**:
- 所有服务可正确解析
- 生命周期正确

### 成功指标

- 所有服务正确注册
- 依赖链完整
- 服务解析无异常

---

## 任务清单：CLI 命令模块

### 任务目标

实现所有 CLI 命令，支持命令行交互和 Gateway 服务模式。

### 相关方案文档

- [CLI.md](../solutions/CLI.md)

### 任务依赖

- 依赖注入配置模块
- 所有核心模块

### 任务列表

#### Task 4.2.1: 定义 ICliCommand 接口

**描述**: 定义 CLI 命令接口。

**交付物**:
- ICliCommand.cs 接口文件
- Name、Description 属性
- ExecuteAsync 方法声明

**完成标准**:
- 接口定义与设计文档一致

---

#### Task 4.2.2: 实现命令注册器

**描述**: 实现命令注册和发现机制。

**交付物**:
- CommandRegistry.cs 文件
- GetCommands 方法实现

**完成标准**:
- 自动发现所有命令
- 支持命令列表

---

#### Task 4.2.3: 实现 onboard 命令

**描述**: 实现初始化 Agent 工作目录命令。

**交付物**:
- OnboardCommand.cs 文件
- 目录创建逻辑
- 默认文件生成

**完成标准**:
- 正确创建目录结构
- 正确生成默认文件
- 支持覆盖确认

---

#### Task 4.2.4: 实现 agent 命令

**描述**: 实现启动 Agent 交互模式命令。

**交付物**:
- AgentCommand.cs 文件
- REPL 循环实现
- 用户输入处理

**完成标准**:
- 正确启动 Agent
- 支持多轮对话
- 支持退出命令

---

#### Task 4.2.5: 实现 gateway 命令

**描述**: 实现启动 Gateway 服务模式命令。

**交付物**:
- GatewayCommand.cs 文件
- 多通道启动逻辑
- HTTP 健康检查端点

**完成标准**:
- 正确启动所有通道
- 支持健康检查
- 支持优雅关闭

---

#### Task 4.2.6: 实现 status 命令

**描述**: 实现显示 Agent 状态命令。

**交付物**:
- StatusCommand.cs 文件
- 状态收集逻辑
- JSON 输出支持

**完成标准**:
- 正确显示 Agent 信息
- 正确显示通道状态
- 支持 JSON 格式

---

#### Task 4.2.7: 实现 config 命令

**描述**: 实现配置管理命令。

**交付物**:
- ConfigCommand.cs 文件
- 配置读写逻辑

**完成标准**:
- 支持列出配置
- 支持获取配置项
- 支持设置配置项

---

#### Task 4.2.8: 实现 session 命令

**描述**: 实现会话管理命令。

**交付物**:
- SessionCommand.cs 文件
- 会话操作逻辑

**完成标准**:
- 支持列出会话
- 支持清除会话
- 支持导出会话

---

#### Task 4.2.9: 实现 cron 命令

**描述**: 实现定时任务管理命令。

**交付物**:
- CronCommand.cs 文件
- 任务操作逻辑

**完成标准**:
- 支持列出任务
- 支持添加/删除任务
- 支持启用/禁用任务
- 支持立即执行

---

#### Task 4.2.10: 实现 mcp 命令

**描述**: 实现 MCP 服务器管理命令。

**交付物**:
- McpCommand.cs 文件
- MCP 操作逻辑

**完成标准**:
- 支持列出服务器
- 支持列出工具
- 支持连接/断开

---

#### Task 4.2.11: 实现程序入口

**描述**: 实现主程序入口和命令行解析。

**交付物**:
- Program.cs 文件
- System.CommandLine 集成
- 命令路由逻辑

**完成标准**:
- 正确解析命令行参数
- 正确路由到命令
- 支持帮助信息

---

#### Task 4.2.12: 编写 CLI 命令单元测试

**描述**: 编写 CLI 命令的单元测试。

**交付物**:
- NanoBot.Cli.Tests 项目
- 各命令测试文件

**完成标准**:
- 测试覆盖率 >= 75%
- 所有测试通过

### 成功指标

- 所有命令正确实现
- 命令行解析正确
- 帮助信息完整
- 单元测试覆盖率 >= 75%

---

## 任务清单：集成测试模块

### 任务目标

实现端到端测试和集成测试，验证系统整体功能。

### 相关方案文档

- [Testing.md](../solutions/Testing.md)

### 任务依赖

- 所有模块已完成

### 任务列表

#### Task 4.3.1: 创建集成测试项目

**描述**: 创建集成测试项目结构。

**交付物**:
- NanoBot.Integration.Tests 项目
- 测试配置文件

**完成标准**:
- 项目结构正确
- 测试框架配置完成

---

#### Task 4.3.2: 实现 Agent 循环集成测试

**描述**: 实现 Agent 循环的端到端测试。

**交付物**:
- AgentLoopIntegrationTests.cs 文件
- 完整循环测试

**完成标准**:
- 测试消息处理流程
- 测试工具调用流程
- 测试会话持久化

---

#### Task 4.3.3: 实现通道集成测试

**描述**: 实现通道的集成测试。

**交付物**:
- ChannelIntegrationTests.cs 文件
- 消息收发测试

**完成标准**:
- 测试消息接收
- 测试消息发送
- 测试消息路由

---

#### Task 4.3.4: 实现提供商集成测试

**描述**: 实现提供商的集成测试。

**交付物**:
- ProviderIntegrationTests.cs 文件
- API 调用测试

**完成标准**:
- 测试实际 API 调用
- 测试流式响应
- 测试错误处理

---

#### Task 4.3.5: 实现端到端测试

**描述**: 实现完整的端到端测试。

**交付物**:
- EndToEndTests.cs 文件
- 完整流程测试

**完成标准**:
- 测试从输入到输出的完整流程
- 测试多轮对话
- 测试错误恢复

---

#### Task 4.3.6: 实现测试工具和 Mock

**描述**: 实现测试辅助工具和 Mock 对象。

**交付物**:
- MockLLMProvider.cs 文件
- MockChannel.cs 文件
- TestFixture.cs 文件

**完成标准**:
- Mock 对象正确模拟行为
- 测试夹具正确初始化

---

#### Task 4.3.7: 编写 Docker 测试脚本

**描述**: 编写 Docker 环境的测试脚本。

**交付物**:
- test-docker.sh 脚本
- Docker 测试流程

**完成标准**:
- 正确构建镜像
- 正确运行测试
- 正确验证输出

### 成功指标

- 集成测试覆盖主要流程
- 端到端测试通过
- Docker 测试通过

---

## 任务清单：部署准备模块

### 任务目标

准备 Docker 部署和发布配置。

### 相关方案文档

- [Testing.md](../solutions/Testing.md) - Docker 测试

### 任务依赖

- 所有模块已完成
- 集成测试通过

### 任务列表

#### Task 4.4.1: 创建 Dockerfile

**描述**: 创建 Docker 镜像构建文件。

**交付物**:
- Dockerfile 文件
- 多阶段构建配置

**完成标准**:
- 镜像大小合理
- 构建过程正确
- 运行时配置正确

---

#### Task 4.4.2: 创建 docker-compose 配置

**描述**: 创建 Docker Compose 编排配置。

**交付物**:
- docker-compose.yml 文件
- 环境变量配置

**完成标准**:
- 正确编排服务
- 支持环境变量注入
- 支持卷挂载

---

#### Task 4.4.3: 创建发布配置

**描述**: 创建 .NET 发布配置。

**交付物**:
- 发布脚本
- 发布配置文件

**完成标准**:
- 支持多平台发布
- 支持单文件发布
- 支持裁剪发布

---

#### Task 4.4.4: 创建示例配置文件

**描述**: 创建示例配置文件和文档。

**交付物**:
- config.example.json 文件
- 环境变量示例

**完成标准**:
- 配置示例完整
- 注释清晰

---

#### Task 4.4.5: 创建启动脚本

**描述**: 创建应用启动脚本。

**交付物**:
- start.sh 脚本
- start.ps1 脚本

**完成标准**:
- 正确初始化环境
- 正确启动应用

---

#### Task 4.4.6: 验证部署流程

**描述**: 验证完整的部署流程。

**交付物**:
- 部署验证报告
- 问题修复

**完成标准**:
- Docker 构建成功
- Docker 运行成功
- 功能验证通过

### 成功指标

- Docker 镜像构建成功
- Docker 容器运行正常
- 发布包可用

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| CLI 命令解析错误 | 中 | 低 | 完善单元测试，边界条件测试 |
| 服务注册遗漏 | 高 | 低 | 自动化注册验证，集成测试覆盖 |
| 部署环境差异 | 中 | 中 | 多环境测试，容器化部署 |
| 性能问题 | 中 | 中 | 性能测试，优化关键路径 |

## 阶段完成标准

- 所有任务清单完成
- 所有单元测试通过
- 所有集成测试通过
- Docker 部署验证通过
- 代码审查通过
- 文档更新完成

## 项目完成

完成本阶段后，NanoBot.Net 项目实现完成，可进入维护和迭代阶段。
