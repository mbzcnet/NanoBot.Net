# Phase 3: Agent 核心层实现计划

本阶段实现 NanoBot.Net 的 Agent 核心层，包括 Agent 循环、上下文构建、记忆管理和会话管理。

## 阶段目标

实现完整的 Agent 运行时，支持多轮对话、工具调用循环、记忆持久化和会话管理。

## 相关方案文档

- [Agent-Core.md](../solutions/Agent-Core.md) - Agent 核心层设计

## 阶段依赖

- Phase 1 基础设施层已完成
- Phase 2 核心服务层已完成
- LLM 提供商可用
- 工具系统可用
- 消息总线可用
- Workspace 管理可用

## 任务清单概览

| 任务清单 | 主要内容 | 并行度 |
|----------|----------|--------|
| [记忆管理模块](#任务清单-记忆管理模块) | IMemoryStore 实现 | 高 |
| [会话管理模块](#任务清单-会话管理模块) | ISessionManager 实现 | 高 |
| [Agent 上下文模块](#任务清单-agent-上下文模块) | IAgentContext 实现 | 高 |
| [Agent 核心模块](#任务清单-agent-核心模块) | IAgent 实现 | 中 |

---

## 任务清单：记忆管理模块

### 任务目标

实现记忆存储接口，管理 MEMORY.md 和 HISTORY.md 文件。

### 相关方案文档

- [Agent-Core.md](../solutions/Agent-Core.md) - IMemoryStore 接口

### 任务依赖

- Workspace 管理模块（需要文件路径）
- 配置管理模块（需要 MemoryConfig）

### 任务列表

#### Task 3.1.1: 定义记忆存储类型

**描述**: 定义记忆存储相关的数据类型。

**交付物**:
- HistoryEntry.cs 文件

**完成标准**:
- 类型定义与设计文档一致
- 包含时间戳、角色、内容、工具信息

---

#### Task 3.1.2: 定义 IMemoryStore 接口

**描述**: 定义记忆存储接口。

**交付物**:
- IMemoryStore.cs 接口文件
- 读写方法声明
- 历史管理方法声明

**完成标准**:
- 接口定义与设计文档一致
- 支持追加和清理操作

---

#### Task 3.1.3: 实现 MemoryStore 类

**描述**: 实现记忆存储。

**交付物**:
- MemoryStore.cs 实现文件
- MEMORY.md 读写逻辑
- HISTORY.md 追加逻辑

**完成标准**:
- 正确读写记忆文件
- 支持历史条目限制
- 线程安全

---

#### Task 3.1.4: 实现记忆合并逻辑

**描述**: 实现会话消息合并到记忆的逻辑。

**交付物**:
- 记忆合并方法实现
- LLM 总结调用

**完成标准**:
- 正确识别需要合并的消息
- 生成合理的记忆更新

---

#### Task 3.1.5: 编写记忆模块单元测试

**描述**: 编写记忆模块的单元测试。

**交付物**:
- NanoBot.Core.Memory.Tests 项目
- MemoryStoreTests.cs

**完成标准**:
- 测试覆盖率 >= 80%
- 所有测试通过

### 成功指标

- 记忆读写正确
- 历史追加正确
- 合并逻辑正确
- 单元测试覆盖率 >= 80%

---

## 任务清单：会话管理模块

### 任务目标

实现会话管理器，支持会话持久化和缓存。

### 相关方案文档

- [Agent-Core.md](../solutions/Agent-Core.md) - ISessionManager 接口

### 任务依赖

- Workspace 管理模块（需要 sessions 目录）
- 配置管理模块

### 任务列表

#### Task 3.2.1: 定义会话类型

**描述**: 定义会话相关的数据类型。

**交付物**:
- Session.cs 文件
- SessionMessage.cs 文件
- SessionInfo.cs 文件

**完成标准**:
- 类型定义与设计文档一致
- Session 包含 LastConsolidated 属性

---

#### Task 3.2.2: 定义 ISessionManager 接口

**描述**: 定义会话管理器接口。

**交付物**:
- ISessionManager.cs 接口文件
- 会话操作方法声明

**完成标准**:
- 接口定义与设计文档一致

---

#### Task 3.2.3: 实现 SessionManager 类

**描述**: 实现会话管理器。

**交付物**:
- SessionManager.cs 实现文件
- JSONL 持久化实现
- 内存缓存实现

**完成标准**:
- 正确创建和获取会话
- 正确保存和加载会话
- 缓存正确工作

---

#### Task 3.2.4: 实现 JSONL 持久化

**描述**: 实现会话的 JSONL 格式持久化。

**交付物**:
- JSONL 读写逻辑
- 文件路径管理

**完成标准**:
- 正确序列化和反序列化
- 支持追加写入
- 文件格式正确

---

#### Task 3.2.5: 实现会话清理逻辑

**描述**: 实现会话清理和导出功能。

**交付物**:
- 清除会话方法
- 导出会话方法
- 列出会话方法

**完成标准**:
- 正确清除指定会话
- 正确导出会话数据

---

#### Task 3.2.6: 编写会话模块单元测试

**描述**: 编写会话模块的单元测试。

**交付物**:
- NanoBot.Core.Sessions.Tests 项目
- SessionManagerTests.cs
- SessionTests.cs

**完成标准**:
- 测试覆盖率 >= 80%
- 包含 LastConsolidated 持久化测试
- 所有测试通过

### 成功指标

- 会话持久化正确
- 缓存机制有效
- LastConsolidated 正确维护
- 单元测试覆盖率 >= 80%

---

## 任务清单：Agent 上下文模块

### 任务目标

实现 Agent 上下文构建，组装发送给 LLM 的完整上下文。

### 相关方案文档

- [Agent-Core.md](../solutions/Agent-Core.md) - IAgentContext 接口

### 任务依赖

- 记忆管理模块
- 会话管理模块
- Skills 加载模块
- Bootstrap 加载模块

### 任务列表

#### Task 3.3.1: 定义上下文类型

**描述**: 定义上下文相关的数据类型。

**交付物**:
- ChatMessage.cs 文件
- ToolCall.cs 文件（如未在 Phase 2 创建）

**完成标准**:
- 类型定义与设计文档一致
- 支持多种消息角色

---

#### Task 3.3.2: 定义 IAgentContext 接口

**描述**: 定义 Agent 上下文接口。

**交付物**:
- IAgentContext.cs 接口文件
- 上下文构建方法声明

**完成标准**:
- 接口定义与设计文档一致

---

#### Task 3.3.3: 实现 AgentContext 类

**描述**: 实现 Agent 上下文构建。

**交付物**:
- AgentContext.cs 实现文件
- 系统提示词构建
- 历史消息获取

**完成标准**:
- 正确构建系统提示词
- 正确获取对话历史
- 正确获取记忆内容

---

#### Task 3.3.4: 实现系统提示词构建

**描述**: 实现完整的系统提示词构建逻辑。

**交付物**:
- BuildSystemPromptAsync 方法实现
- 各部分内容拼接

**完成标准**:
- 包含核心身份信息
- 包含 Bootstrap 文件内容
- 包含记忆内容
- 包含 Skills 摘要

---

#### Task 3.3.5: 实现 Skills 渐进式加载

**描述**: 实现 Skills 的渐进式加载机制。

**交付物**:
- 始终加载 Skills 的完整内容
- 可用 Skills 的 XML 摘要
- SkillsSummary 格式化

**完成标准**:
- always=true 的 Skills 完整加载
- 其他 Skills 仅显示摘要
- XML 格式正确

---

#### Task 3.3.6: 实现上下文缓存

**描述**: 实现上下文内容的缓存机制。

**交付物**:
- 缓存逻辑实现
- 缓存失效机制

**完成标准**:
- 避免重复构建
- 文件变更时正确失效

---

#### Task 3.3.7: 编写上下文模块单元测试

**描述**: 编写上下文模块的单元测试。

**交付物**:
- NanoBot.Core.Agents.Tests 项目
- AgentContextTests.cs

**完成标准**:
- 测试覆盖率 >= 80%
- 所有测试通过

### 成功指标

- 系统提示词构建正确
- Skills 渐进式加载正确
- 缓存机制有效
- 单元测试覆盖率 >= 80%

---

## 任务清单：Agent 核心模块

### 任务目标

实现 Agent 核心逻辑，包括单轮处理和多轮循环。

### 相关方案文档

- [Agent-Core.md](../solutions/Agent-Core.md) - IAgent 接口

### 任务依赖

- Agent 上下文模块
- LLM 提供商模块
- 工具系统模块
- 消息总线模块
- 会话管理模块
- 记忆管理模块

### 任务列表

#### Task 4.1.1: 定义 Agent 请求响应类型

**描述**: 定义 Agent 请求和响应相关的数据类型。

**交付物**:
- AgentRequest.cs 文件
- AgentResponse.cs 文件
- AgentResponseMetadata.cs 文件

**完成标准**:
- 类型定义与设计文档一致
- 包含完整的元数据

---

#### Task 4.1.2: 定义 IAgent 接口

**描述**: 定义 Agent 接口。

**交付物**:
- IAgent.cs 接口文件
- 单轮和多轮处理方法声明

**完成标准**:
- 接口定义与设计文档一致
- 包含 Id、Name、WorkspacePath 属性

---

#### Task 4.1.3: 实现 Agent 基础类

**描述**: 实现 Agent 基础结构和依赖注入。

**交付物**:
- Agent.cs 实现文件
- 构造函数和依赖注入
- 属性实现

**完成标准**:
- 正确注入所有依赖
- 属性正确初始化

---

#### Task 4.1.4: 实现单轮处理逻辑

**描述**: 实现 ProcessTurnAsync 方法。

**交付物**:
- ProcessTurnAsync 方法实现
- LLM 调用逻辑
- 响应构建逻辑

**完成标准**:
- 正确构建请求
- 正确调用 LLM
- 正确处理响应

---

#### Task 4.1.5: 实现工具调用执行

**描述**: 实现工具调用的执行逻辑。

**交付物**:
- 工具调用解析逻辑
- 工具执行逻辑
- 结果处理逻辑

**完成标准**:
- 正确解析工具调用
- 正确执行工具
- 正确处理执行结果

---

#### Task 4.1.6: 实现多轮循环逻辑

**描述**: 实现 RunLoopAsync 方法。

**交付物**:
- RunLoopAsync 方法实现
- 迭代控制逻辑
- 终止条件判断

**完成标准**:
- 正确执行多轮循环
- 正确处理最大迭代限制
- 正确处理取消请求

---

#### Task 4.1.7: 实现消息历史管理

**描述**: 实现对话历史的追加和管理。

**交付物**:
- 消息追加逻辑
- 工具消息追加逻辑
- 会话更新逻辑

**完成标准**:
- 正确追加用户消息
- 正确追加助手响应
- 正确追加工具结果

---

#### Task 4.1.8: 实现记忆合并触发

**描述**: 实现记忆合并的触发逻辑。

**交付物**:
- 合并条件判断
- 合并执行逻辑
- 会话清理逻辑

**完成标准**:
- 正确判断合并时机
- 正确执行合并
- 正确清理会话

---

#### Task 4.1.9: 实现错误处理和重试

**描述**: 实现 Agent 的错误处理和重试机制。

**交付物**:
- 异常捕获逻辑
- 重试逻辑
- 错误响应构建

**完成标准**:
- 正确捕获和处理异常
- 合理的重试策略
- 友好的错误响应

---

#### Task 4.1.10: 编写 Agent 核心单元测试

**描述**: 编写 Agent 核心的单元测试。

**交付物**:
- AgentTests.cs 文件
- AgentLoopIntegrationTests.cs 文件

**完成标准**:
- 测试覆盖率 >= 80%
- 包含集成测试
- 所有测试通过

### 成功指标

- 单轮处理正确
- 多轮循环正确
- 工具调用执行正确
- 记忆合并正确
- 单元测试覆盖率 >= 80%

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| LLM 响应超时 | 高 | 中 | 实现超时控制和重试 |
| 工具执行异常 | 中 | 中 | 完善错误处理，隔离执行 |
| 记忆合并失败 | 中 | 低 | 备份机制，手动恢复 |
| 会话数据损坏 | 高 | 低 | JSONL 追加写入，定期备份 |

## 阶段完成标准

- 所有任务清单完成
- 所有单元测试通过
- 代码审查通过
- Agent 循环可正常运行
- 工具调用可正常执行
- 记忆和会话持久化正常

## 下一阶段

完成本阶段后，进入 [Phase 4: 应用层](./Phase4-Application.md)。
